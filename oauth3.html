<script>
  function main() {
    var params = {};
    var anchor;

    anchor = document.createElement('a');
    anchor.href = window.location.href;
    anchor.search.substr(1).split('&').forEach(function (pair) {
      pair = pair.split('=');
      var key = decodeURIComponent(pair[0]);
      var val = decodeURIComponent(pair[1]);

      params[key] = val;
    });
    anchor.hash.substr(1).split('&').forEach(function (pair) {
      pair = pair.split('=');
      var key = decodeURIComponent(pair[0]);
      var val = decodeURIComponent(pair[1]);

      if (params[key]) {
        console.warn("overwriting key '" + key + "' '" + params[key] + "'");
      }
      params[key] = val;
    });

    params.url = window.location.href;

    console.log('[oauth3.html] params');
    console.log(params);
    if (params.logout) {
      // TODO specify specific account or all?
      window.location.href = '/#/logout/' + (params.callback || 'completeLogin');
      return;
    }
    else if (params.close) {
      // whatevs
    }
    else if (!(params.browser_state || params.state)) {
      window.alert("callback URLs should include 'browser_state' (authorization code)"
        + " or 'state' (implicit grant))");
    }

    setTimeout(function () {
      // opener is for popup window, new tab
      // parent is for iframe
      if (params.callback && params.callback !== 'completeLogin') {
        (window.opener||window.parent)['__oauth3_' + params.callback](params);
      } else {
        (window.opener||window.parent).completeLogin(null, params.url, params);
      }
    }, 10);

    // iOS Webview (namely Chrome) workaround
    setTimeout(function () {
      window.open('', '_self', '');
      window.close();
    }, 50);

    setTimeout(function () {
      var i;
      var len = localStorage.length;
      var key;

      for (i = 0; i < len; i += 1) {
        key = localStorage.key(i);
        // TODO check updatedAt
        if (/^oauth3\./.test(key)) {
          localStorage.removeItem(key);
        }
      }
      params.updatedAt = Date.now();
      localStorage.setItem('oauth3.' + (params.browser_state || params.state), JSON.stringify(params));
    }, 0);
  }
  main();
</script>

<p>Redirecting... </p>

<a href="javascript:window.opener.completeLogin(name, window.location.href);">close</a>
