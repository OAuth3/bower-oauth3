<script>
  function main() {
    var myself = location.protocol + '//' + location.host + location.pathname;
    var params = {};
    var anchor;
    var err;
    var browserState;
    var browserCallback;

    function parseParams() {
      anchor = document.createElement('a');
      anchor.href = window.location.href;
      anchor.search.substr(1).split('&').forEach(function (pair) {
        pair = pair.split('=');
        var key = decodeURIComponent(pair[0]);
        var val = decodeURIComponent(pair[1]);

        params[key] = val;
      });
      anchor.hash.substr(1).split('&').forEach(function (pair) {
        pair = pair.split('=');
        var key = decodeURIComponent(pair[0]);
        var val = decodeURIComponent(pair[1]);

        if (params[key]) {
          console.warn("overwriting key '" + key + "' '" + params[key] + "'");
        }
        params[key] = val;
      });

      return params;
    }

    function querystringify(params) {
      var arr = [];

      Object.keys(params).forEach(function (k) {
        arr.push(encodeURIComponent(k) + '=' + encodeURIComponent(params[k]));
      });

      return arr.join('&');
    }

    function phoneAway() {
      // TODO test for ? / #
      window.location.href = params.redirect_uri + '#' + querystringify(params);
    }

    function lintAndSetRedirectable() {
      if (!params.redirect_uri) {
        window.alert('redirect_uri not defined');
        err = new Error('redirect_uri not defined');
        console.error(err.message);
        console.warn(err.stack);
        params.redirect_uri = document.referer;
        return false;
      }

      if (!browserState) {
        params.error = "E_NO_BROWSER_STATE";
        params.error_description = "you must specify a state parameter";
        return false;
      }

      localStorage.setItem('oauth3.states.' + browserState, JSON.stringify(params));
      return true;
    }

    function redirectCallback() {
      var redirect_uri = params.redirect_uri;
      delete params.redirect_uri;
      params.close = true;
      params.callback = browserState;

      var url = redirect_uri + '#' + querystringify(params);

      window.location.href = url;
    }

    params = parseParams();
    params.url = window.location.href;
    browserState = params.browser_state || params.state;

    if (!params.provider_uri) {
      browserCallback = params.callback || browserState;
    } else {
      // deprecated
      browserCallback = 'completeLogin';
    }

    if ('directives' === params.action || params.directives) {
      if (!lintAndSetRedirectable()) {
        phoneAway();
      }

      var updatedAt = new Date(localStorage.getItem('oauth3.directives.updated_at')).valueOf();
      var fresh = (Date.now() - updatedAt) < (24 * 60 * 60 * 1000);
      var directives = localStorage.getItem('oauth3.directives');
      var redirected = false;

      function redirectIf() {
        if (redirected) {
          return;
        }

        redirected = true;
        redirectCallback();
      }

      if (directives) {
        params.directives = directives;
        redirectIf();
        if (fresh) {
          return;
        }
      }

      var req = new XMLHttpRequest();
      req.open('GET', 'oauth3.json', true);
      req.addEventListener('readystatechange', function () {
        if (4 !== req.readyState) {
          return;
        }

        if (200 !== req.status) {
          params.error = "E_STATUS_" + req.status;
          params.error_description = "expected 200 OK json or text response for oauth3.json but got '" + req.status + "'";
          redirectIf();
          return;
        }

        try {
          directives = btoa(JSON.stringify(JSON.parse(req.responseText)));
          params.directives = directives;
          localStorage.setItem('oauth3.directives', directives);
          localStorage.setItem('oauth3.directives.updated_at', new Date().toISOString());
        } catch(e) {
          params.error = "E_PARSE_JSON";
          params.error_description = e.message;
          console.error(params.error);
          console.error(params.error_description);
          console.error(req.responseText);
        }

        redirectIf();
      });
      req.send();
    }
    else if ('logout' === params.action || params.logout) {
      lintAndSetRedirectable();

      // TODO specify specific account or all?
      window.location.href = '/#/logout/' + browserState;
      return;
    }
    else if (params.logout_callback) {
      if (!browserState) {
        params.error = "E_NO_BROWSER_STATE";
        params.error_description = "you must specify a state parameter";
        phoneAway();
        return;
      }

      params = JSON.parse(localStorage.getItem('oauth3.states.' + browserState, params));
      window.location.href = params.redirect_uri + '#close=true&state=' + browserState;
      return;
    }
    else if (params.close) {
      // don't do anything, phoneHome() will call the final callback
      params.callback = browserState;
    }
    else if (!(params.browser_state || params.state)) {
      window.alert("callback URLs should include 'browser_state' (authorization code)"
        + " or 'state' (implicit grant))");
    }

    function phoneHome() {
      if (browserCallback === 'completeLogin') {
        // Deprecated
        (window.opener||window.parent).completeLogin(null, params.url, params);
      } else {
        (window.opener||window.parent)['__oauth3_' + browserCallback](params);
      }
    }

    setTimeout(function () {
      // opener is for popup window, new tab
      // parent is for iframe
      phoneHome();
    }, 10);

    // iOS Webview (namely Chrome) workaround
    setTimeout(function () {
      window.open('', '_self', '');
      window.close();
    }, 50);

    setTimeout(function () {
      var i;
      var len = localStorage.length;
      var key;

      for (i = 0; i < len; i += 1) {
        key = localStorage.key(i);
        // TODO check updatedAt
        if (/^oauth3\./.test(key)) {
          localStorage.removeItem(key);
        }
      }
      params.updatedAt = Date.now();
      localStorage.setItem('oauth3.' + (params.browser_state || params.state), JSON.stringify(params));
    }, 0);
  }
  main();
</script>

<p>Redirecting... </p>

<a href="javascript:window.opener.completeLogin(name, window.location.href);">close</a>
